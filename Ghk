private static void updateBookmarksInParagraphRuns(XWPFParagraph para, Map<String, String> bookmarkValues) {
    List<XWPFRun> runs = para.getRuns();

    CTBookmark currentBookmark = null;
    int bookmarkId = -1;
    String bookmarkName = null;
    boolean inside = false;
    boolean replaced = false;

    for (int i = 0; i < runs.size(); i++) {
        XWPFRun run = runs.get(i);
        CTR ctr = run.getCTR();

        // Detect bookmark start inside this run
        for (CTBookmark bookmark : ctr.getBookmarkStartList()) {
            bookmarkId = bookmark.getId().intValue();
            bookmarkName = bookmark.getName();
            currentBookmark = bookmark;
            inside = true;
            replaced = false;
        }

        // Inside bookmark: try to replace only non-formfield text
        if (inside && bookmarkName != null && bookmarkValues.containsKey(bookmarkName)) {
            if (!isFormFieldRun(run) && !replaced) {
                run.setText(bookmarkValues.get(bookmarkName), 0);
                replaced = true;
            }
        }

        // Detect bookmark end inside this run
        for (CTMarkupRange end : ctr.getBookmarkEndList()) {
            if (end.getId().intValue() == bookmarkId) {
                if (!replaced && bookmarkName != null && bookmarkValues.containsKey(bookmarkName)) {
                    // Insert new text run if not replaced yet
                    XWPFRun newRun = para.insertNewRun(i);
                    newRun.setText(bookmarkValues.get(bookmarkName));
                }
                inside = false;
                currentBookmark = null;
                bookmarkName = null;
                bookmarkId = -1;
                replaced = false;
            }
        }
    }
}
